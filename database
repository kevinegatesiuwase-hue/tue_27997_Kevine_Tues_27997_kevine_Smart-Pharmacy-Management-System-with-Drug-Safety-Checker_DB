-- SMART PHARMACY SYSTEM - DROP & RECREATE ALL TABLES
-- Run this entire script at once
-- ============================================

-- DISABLE FOREIGN KEY CONSTRAINTS TEMPORARILY
-- (This helps avoid "constraint exists" errors when dropping)

-- DROP TABLES IN REVERSE ORDER (due to foreign key dependencies)
BEGIN
    -- First, try to drop child tables
    EXECUTE IMMEDIATE 'DROP TABLE stock_alerts CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE audit_log CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE dispense_log CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE drug_interactions CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE prescription_lines CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE prescriptions CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE batches CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE patients CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE medications CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

DBMS_OUTPUT.PUT_LINE('All existing tables dropped (if they existed)');

-- ============================================
-- NOW CREATE ALL TABLES FRESH
-- ============================================

-- 1. MEDICATIONS (FOUNDATION TABLE)
CREATE TABLE medications (
    medication_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    generic_name VARCHAR2(100),
    requires_prescription CHAR(1) DEFAULT 'Y' CHECK (requires_prescription IN ('Y', 'N')),
    active_status VARCHAR2(10) DEFAULT 'ACTIVE' CHECK (active_status IN ('ACTIVE', 'DISCONTINUED')),
    CONSTRAINT uk_med_name UNIQUE (name)
);

DBMS_OUTPUT.PUT_LINE('Table MEDICATIONS created successfully');

-- 2. PATIENTS (SECOND FOUNDATION TABLE)
CREATE TABLE patients (
    patient_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    dob DATE NOT NULL,
    phone VARCHAR2(15),
    allergies VARCHAR2(500)
);

DBMS_OUTPUT.PUT_LINE('Table PATIENTS created successfully');

-- 3. BATCHES (NEEDS MEDICATIONS)
CREATE TABLE batches (
    batch_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    medication_id NUMBER NOT NULL,
    batch_number VARCHAR2(50) NOT NULL,
    expiry_date DATE NOT NULL,
    qty_received NUMBER NOT NULL CHECK (qty_received > 0),
    qty_on_hand NUMBER NOT NULL CHECK (qty_on_hand >= 0),
    purchase_price NUMBER(10,2) CHECK (purchase_price > 0),
    CONSTRAINT fk_batch_med FOREIGN KEY (medication_id) REFERENCES medications(medication_id),
    CONSTRAINT uk_batch_num UNIQUE (batch_number)
);

DBMS_OUTPUT.PUT_LINE('Table BATCHES created successfully');

-- 4. PRESCRIPTIONS (NEEDS PATIENTS)
CREATE TABLE prescriptions (
    prescription_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    patient_id NUMBER NOT NULL,
    prescriber_name VARCHAR2(100) NOT NULL,
    prescription_date DATE DEFAULT SYSDATE,
    status VARCHAR2(20) DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'DISPENSED', 'CANCELLED')),
    CONSTRAINT fk_pres_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
);

DBMS_OUTPUT.PUT_LINE('Table PRESCRIPTIONS created successfully');

-- 5. DRUG_INTERACTIONS (NEEDS MEDICATIONS)
CREATE TABLE drug_interactions (
    interaction_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    med1_id NUMBER NOT NULL,
    med2_id NUMBER NOT NULL,
    severity VARCHAR2(20) NOT NULL CHECK (severity IN ('LOW', 'MODERATE', 'HIGH')),
    description VARCHAR2(500),
    recommended_action VARCHAR2(500),
    CONSTRAINT fk_interaction_med1 FOREIGN KEY (med1_id) REFERENCES medications(medication_id),
    CONSTRAINT fk_interaction_med2 FOREIGN KEY (med2_id) REFERENCES medications(medication_id),
    CONSTRAINT chk_med_order CHECK (med1_id < med2_id)  -- Prevents duplicate (A,B) and (B,A)
);

DBMS_OUTPUT.PUT_LINE('Table DRUG_INTERACTIONS created successfully');

-- 6. PRESCRIPTION_LINES (NEEDS PRESCRIPTIONS & MEDICATIONS)
CREATE TABLE prescription_lines (
    line_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    prescription_id NUMBER NOT NULL,
    medication_id NUMBER NOT NULL,
    dosage VARCHAR2(50),
    quantity_prescribed NUMBER NOT NULL CHECK (quantity_prescribed > 0),
    quantity_dispensed NUMBER DEFAULT 0 CHECK (quantity_dispensed >= 0),
    CONSTRAINT fk_line_pres FOREIGN KEY (prescription_id) REFERENCES prescriptions(prescription_id),
    CONSTRAINT fk_line_med FOREIGN KEY (medication_id) REFERENCES medications(medication_id)
);

DBMS_OUTPUT.PUT_LINE('Table PRESCRIPTION_LINES created successfully');

-- 7. DISPENSE_LOG (NEEDS BATCHES & PRESCRIPTION_LINES)
CREATE TABLE dispense_log (
    dispense_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    prescription_id NUMBER,
    line_id NUMBER,
    batch_id NUMBER NOT NULL,
    qty_dispensed NUMBER NOT NULL CHECK (qty_dispensed > 0),
    dispensed_by VARCHAR2(100),
    dispensed_at TIMESTAMP DEFAULT SYSTIMESTAMP,
    override_flag CHAR(1) DEFAULT 'N' CHECK (override_flag IN ('Y', 'N')),
    override_reason VARCHAR2(500),
    CONSTRAINT fk_disp_pres FOREIGN KEY (prescription_id) REFERENCES prescriptions(prescription_id),
    CONSTRAINT fk_disp_line FOREIGN KEY (line_id) REFERENCES prescription_lines(line_id),
    CONSTRAINT fk_disp_batch FOREIGN KEY (batch_id) REFERENCES batches(batch_id)
);

DBMS_OUTPUT.PUT_LINE('Table DISPENSE_LOG created successfully');

-- 8. AUDIT_LOG (STANDALONE)
CREATE TABLE audit_log (
    log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    table_name VARCHAR2(50),
    operation VARCHAR2(10) CHECK (operation IN ('INSERT', 'UPDATE', 'DELETE')),
    record_id NUMBER,
    old_values CLOB,
    new_values CLOB,
    changed_by VARCHAR2(100),
    change_time TIMESTAMP DEFAULT SYSTIMESTAMP
);

DBMS_OUTPUT.PUT_LINE('Table AUDIT_LOG created successfully');

-- 9. STOCK_ALERTS (NEEDS MEDICATIONS)
CREATE TABLE stock_alerts (
    alert_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    medication_id NUMBER NOT NULL,
    alert_type VARCHAR2(20) CHECK (alert_type IN ('LOW_STOCK', 'NEAR_EXPIRY')),
    qty_on_hand NUMBER,
    alert_time TIMESTAMP DEFAULT SYSTIMESTAMP,
    resolved_flag CHAR(1) DEFAULT 'N' CHECK (resolved_flag IN ('Y', 'N')),
    CONSTRAINT fk_alert_med FOREIGN KEY (medication_id) REFERENCES medications(medication_id)
);

DBMS_OUTPUT.PUT_LINE('Table STOCK_ALERTS created successfully');

-- ============================================
-- CREATE INDEXES
-- ============================================

CREATE INDEX idx_medications_name ON medications(name);
CREATE INDEX idx_medications_status ON medications(active_status);

CREATE INDEX idx_batches_med_expiry ON batches(medication_id, expiry_date);
CREATE INDEX idx_batches_expiry ON batches(expiry_date);

CREATE INDEX idx_patients_name ON patients(name);

CREATE INDEX idx_prescriptions_patient ON prescriptions(patient_id);
CREATE INDEX idx_prescriptions_date ON prescriptions(prescription_date);

CREATE INDEX idx_pres_lines_pres ON prescription_lines(prescription_id);
CREATE INDEX idx_pres_lines_med ON prescription_lines(medication_id);

CREATE INDEX idx_dispense_batch ON dispense_log(batch_id);
CREATE INDEX idx_dispense_date ON dispense_log(dispensed_at);

CREATE INDEX idx_interactions_med1 ON drug_interactions(med1_id);
CREATE INDEX idx_interactions_med2 ON drug_interactions(med2_id);

DBMS_OUTPUT.PUT_LINE('All indexes created successfully');

-- ============================================
-- VERIFICATION
-- ============================================

-- Show all tables created
SELECT table_name, 'âœ“ CREATED' as status
FROM user_tables
WHERE table_name IN ('MEDICATIONS', 'PATIENTS', 'BATCHES', 'PRESCRIPTIONS', 
                     'PRESCRIPTION_LINES', 'DRUG_INTERACTIONS', 'DISPENSE_LOG', 
                     'AUDIT_LOG', 'STOCK_ALERTS')
ORDER BY table_name;

-- Count tables
SELECT 'TOTAL TABLES CREATED: ' || COUNT(*) as summary
FROM user_tables
WHERE table_name IN ('MEDICATIONS', 'PATIENTS', 'BATCHES', 'PRESCRIPTIONS', 
                     'PRESCRIPTION_LINES', 'DRUG_INTERACTIONS', 'DISPENSE_LOG', 
                     'AUDIT_LOG', 'STOCK_ALERTS');  

FOR t IN (SELECT table_name FROM user_tables WHERE table_name IN (
        'MEDICATIONS', 'PATIENTS', 'BATCHES', 'PRESCRIPTIONS',
        'PRESCRIPTION_LINES', 'DRUG_INTERACTIONS', 'DISPENSE_LOG',
        'AUDIT_LOG', 'STOCK_ALERTS', 'PHARMACISTS'
    )) LOOP
        EXECUTE IMMEDIATE 'DROP TABLE ' || t.table_name || ' CASCADE CONSTRAINTS';
    END LOOP;
END;
/

-- 2. CREATE TABLES WITHOUT PRIMARY KEYS
CREATE TABLE medications (
    medication_id NUMBER,
    name VARCHAR2(255),
    requires_prescription CHAR(1),
    active_status VARCHAR2(20),
    dosage_form VARCHAR2(50),
    strength VARCHAR2(100),
    manufacturer VARCHAR2(255)
);

CREATE TABLE patients (
    patient_id NUMBER,
    name VARCHAR2(255),
    dob DATE,
    gender CHAR(1),
    phone VARCHAR2(20),
    address VARCHAR2(500),
    email VARCHAR2(100)
);

CREATE TABLE batches (
    batch_id NUMBER,
    medication_id NUMBER,
    batch_number VARCHAR2(100),
    expiry_date DATE,
    qty_received NUMBER,
    qty_on_hand NUMBER,
    cost_price NUMBER(10,2),
    received_date DATE
);

CREATE TABLE prescriptions (
    prescription_id NUMBER,
    patient_id NUMBER,
    prescriber_name VARCHAR2(255),
    prescriber_license VARCHAR2(100),
    issue_date DATE,
    status VARCHAR2(20),
    created_date DATE
);

CREATE TABLE prescription_lines (
    line_id NUMBER,
    prescription_id NUMBER,
    medication_id NUMBER,
    quantity_prescribed NUMBER,
    quantity_dispensed NUMBER,
    instructions VARCHAR2(500),
    days_supply NUMBER
);

CREATE TABLE drug_interactions (
    interaction_id NUMBER,
    med1_id NUMBER,
    med2_id NUMBER,
    severity VARCHAR2(20),
    description VARCHAR2(1000),
    recommendation VARCHAR2(500)
);

CREATE TABLE dispense_log (
    dispense_id NUMBER,
    prescription_id NUMBER,
    line_id NUMBER,
    batch_id NUMBER,
    qty_dispensed NUMBER,
    dispense_date DATE,
    pharmacist_id NUMBER,
    override_flag CHAR(1),
    override_reason VARCHAR2(500)
);

CREATE TABLE audit_log (
    log_id NUMBER,
    table_name VARCHAR2(100),
    operation VARCHAR2(10),
    old_values CLOB,
    new_values CLOB,
    changed_by VARCHAR2(100),
    changed_date DATE
);

CREATE TABLE stock_alerts (
    alert_id NUMBER,
    medication_id NUMBER,
    alert_type VARCHAR2(20),
    alert_date DATE,
    message VARCHAR2(500),
    resolved_flag CHAR(1),
    resolved_date DATE,
    resolved_by VARCHAR2(100)
);

CREATE TABLE pharmacists (
    pharmacist_id NUMBER,
    name VARCHAR2(255),
    license_number VARCHAR2(100),
    email VARCHAR2(100),
    phone VARCHAR2(20),
    active_status CHAR(1)
);

-- 3. ADD PRIMARY KEYS (Now this will work!)
ALTER TABLE medications ADD CONSTRAINT pk_medications PRIMARY KEY (medication_id);
ALTER TABLE patients ADD CONSTRAINT pk_patients PRIMARY KEY (patient_id);
ALTER TABLE batches ADD CONSTRAINT pk_batches PRIMARY KEY (batch_id);
ALTER TABLE prescriptions ADD CONSTRAINT pk_prescriptions PRIMARY KEY (prescription_id);
ALTER TABLE prescription_lines ADD CONSTRAINT pk_pres_lines PRIMARY KEY (line_id);
ALTER TABLE drug_interactions ADD CONSTRAINT pk_interactions PRIMARY KEY (interaction_id);
ALTER TABLE dispense_log ADD CONSTRAINT pk_dispense_log PRIMARY KEY (dispense_id);
ALTER TABLE audit_log ADD CONSTRAINT pk_audit_log PRIMARY KEY (log_id);
ALTER TABLE stock_alerts ADD CONSTRAINT pk_stock_alerts PRIMARY KEY (alert_id);
ALTER TABLE pharmacists ADD CONSTRAINT pk_pharmacists PRIMARY KEY (pharmacist_id);

SELECT 'âœ… Step 1-3 Complete: Tables created and primary keys added' as status FROM dual;

-- 4. ADD FOREIGN KEYS
ALTER TABLE batches ADD CONSTRAINT fk_batch_med FOREIGN KEY (medication_id) REFERENCES medications(medication_id);
ALTER TABLE prescriptions ADD CONSTRAINT fk_pres_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id);
ALTER TABLE prescription_lines ADD CONSTRAINT fk_line_pres FOREIGN KEY (prescription_id) REFERENCES prescriptions(prescription_id);
ALTER TABLE prescription_lines ADD CONSTRAINT fk_line_med FOREIGN KEY (medication_id) REFERENCES medications(medication_id);
ALTER TABLE drug_interactions ADD CONSTRAINT fk_int_med1 FOREIGN KEY (med1_id) REFERENCES medications(medication_id);
ALTER TABLE drug_interactions ADD CONSTRAINT fk_int_med2 FOREIGN KEY (med2_id) REFERENCES medications(medication_id);
ALTER TABLE dispense_log ADD CONSTRAINT fk_disp_pres FOREIGN KEY (prescription_id) REFERENCES prescriptions(prescription_id);
ALTER TABLE dispense_log ADD CONSTRAINT fk_disp_line FOREIGN KEY (line_id) REFERENCES prescription_lines(line_id);
ALTER TABLE dispense_log ADD CONSTRAINT fk_disp_batch FOREIGN KEY (batch_id) REFERENCES batches(batch_id);
ALTER TABLE dispense_log ADD CONSTRAINT fk_disp_pharmacist FOREIGN KEY (pharmacist_id) REFERENCES pharmacists(pharmacist_id);
ALTER TABLE stock_alerts ADD CONSTRAINT fk_alert_med FOREIGN KEY (medication_id) REFERENCES medications(medication_id);

SELECT 'âœ… Step 4 Complete: Foreign keys added' as status FROM dual;

-- 5. ADD CHECK CONSTRAINTS
-- Medications
ALTER TABLE medications ADD CONSTRAINT chk_med_prescription CHECK (requires_prescription IN ('Y','N'));
ALTER TABLE medications ADD CONSTRAINT chk_med_status CHECK (active_status IN ('ACTIVE','DISCONTINUED','OUT_OF_STOCK'));
-- Patients
ALTER TABLE patients ADD CONSTRAINT chk_patient_gender CHECK (gender IN ('M','F','O'));
-- Batches
ALTER TABLE batches ADD CONSTRAINT chk_batch_qty CHECK (qty_received >= 0 AND qty_on_hand >= 0);
ALTER TABLE batches ADD CONSTRAINT chk_cost_price CHECK (cost_price >= 0);
-- Prescriptions
ALTER TABLE prescriptions ADD CONSTRAINT chk_pres_status CHECK (status IN ('PENDING','DISPENSED','CANCELLED','EXPIRED'));
-- Prescription Lines
ALTER TABLE prescription_lines ADD CONSTRAINT chk_line_qty CHECK (quantity_prescribed > 0 AND quantity_dispensed >= 0);
ALTER TABLE prescription_lines ADD CONSTRAINT chk_dispensed_limit CHECK (quantity_dispensed <= quantity_prescribed);
-- Drug Interactions
ALTER TABLE drug_interactions ADD CONSTRAINT chk_int_severity CHECK (severity IN ('LOW','MODERATE','HIGH','CONTRAINDICATED'));
ALTER TABLE drug_interactions ADD CONSTRAINT chk_med_order CHECK (med1_id < med2_id);
-- Dispense Log
ALTER TABLE dispense_log ADD CONSTRAINT chk_dispense_qty CHECK (qty_dispensed > 0);
ALTER TABLE dispense_log ADD CONSTRAINT chk_override_flag CHECK (override_flag IN ('Y','N'));
-- Stock Alerts
ALTER TABLE stock_alerts ADD CONSTRAINT chk_alert_type CHECK (alert_type IN ('LOW_STOCK','NEAR_EXPIRY','EXPIRED','OVERSTOCK'));
ALTER TABLE stock_alerts ADD CONSTRAINT chk_resolved_flag CHECK (resolved_flag IN ('Y','N'));
-- Pharmacists
ALTER TABLE pharmacists ADD CONSTRAINT chk_pharmacist_status CHECK (active_status IN ('Y','N'));

SELECT 'âœ… Step 5 Complete: Check constraints added' as status FROM dual;

-- 6. ADD UNIQUE CONSTRAINTS
ALTER TABLE medications ADD CONSTRAINT uk_med_name UNIQUE (name);
ALTER TABLE patients ADD CONSTRAINT uk_patient_phone UNIQUE (phone);
ALTER TABLE batches ADD CONSTRAINT uk_batch_number UNIQUE (batch_number);
ALTER TABLE drug_interactions ADD CONSTRAINT uk_interaction_pair UNIQUE (med1_id, med2_id);
ALTER TABLE pharmacists ADD CONSTRAINT uk_pharmacist_license UNIQUE (license_number);
ALTER TABLE pharmacists ADD CONSTRAINT uk_pharmacist_email UNIQUE (email);

SELECT 'âœ… Step 6 Complete: Unique constraints added' as status FROM dual;

-- 7. ADD NOT NULL CONSTRAINTS
-- Medications
ALTER TABLE medications MODIFY medication_id NOT NULL;
ALTER TABLE medications MODIFY name NOT NULL;
ALTER TABLE medications MODIFY requires_prescription NOT NULL;
ALTER TABLE medications MODIFY active_status NOT NULL;
-- Patients
ALTER TABLE patients MODIFY patient_id NOT NULL;
ALTER TABLE patients MODIFY name NOT NULL;
ALTER TABLE patients MODIFY dob NOT NULL;
ALTER TABLE patients MODIFY gender NOT NULL;
ALTER TABLE patients MODIFY phone NOT NULL;
-- Batches
ALTER TABLE batches MODIFY batch_id NOT NULL;
ALTER TABLE batches MODIFY medication_id NOT NULL;
ALTER TABLE batches MODIFY batch_number NOT NULL;
ALTER TABLE batches MODIFY expiry_date NOT NULL;
ALTER TABLE batches MODIFY qty_received NOT NULL;
ALTER TABLE batches MODIFY qty_on_hand NOT NULL;
-- Prescriptions
ALTER TABLE prescriptions MODIFY prescription_id NOT NULL;
ALTER TABLE prescriptions MODIFY patient_id NOT NULL;
ALTER TABLE prescriptions MODIFY prescriber_name NOT NULL;
ALTER TABLE prescriptions MODIFY issue_date NOT NULL;
ALTER TABLE prescriptions MODIFY status NOT NULL;
ALTER TABLE prescriptions MODIFY created_date NOT NULL;
-- Prescription Lines
ALTER TABLE prescription_lines MODIFY line_id NOT NULL;
ALTER TABLE prescription_lines MODIFY prescription_id NOT NULL;
ALTER TABLE prescription_lines MODIFY medication_id NOT NULL;
ALTER TABLE prescription_lines MODIFY quantity_prescribed NOT NULL;
ALTER TABLE prescription_lines MODIFY quantity_dispensed NOT NULL;
-- Drug Interactions
ALTER TABLE drug_interactions MODIFY interaction_id NOT NULL;
ALTER TABLE drug_interactions MODIFY med1_id NOT NULL;
ALTER TABLE drug_interactions MODIFY med2_id NOT NULL;
ALTER TABLE drug_interactions MODIFY severity NOT NULL;
-- Dispense Log
ALTER TABLE dispense_log MODIFY dispense_id NOT NULL;
ALTER TABLE dispense_log MODIFY prescription_id NOT NULL;
ALTER TABLE dispense_log MODIFY line_id NOT NULL;
ALTER TABLE dispense_log MODIFY batch_id NOT NULL;
ALTER TABLE dispense_log MODIFY qty_dispensed NOT NULL;
ALTER TABLE dispense_log MODIFY dispense_date NOT NULL;
ALTER TABLE dispense_log MODIFY pharmacist_id NOT NULL;
ALTER TABLE dispense_log MODIFY override_flag NOT NULL;
-- Audit Log
ALTER TABLE audit_log MODIFY log_id NOT NULL;
ALTER TABLE audit_log MODIFY table_name NOT NULL;
ALTER TABLE audit_log MODIFY operation NOT NULL;
ALTER TABLE audit_log MODIFY changed_by NOT NULL;
ALTER TABLE audit_log MODIFY changed_date NOT NULL;
-- Stock Alerts
ALTER TABLE stock_alerts MODIFY alert_id NOT NULL;
ALTER TABLE stock_alerts MODIFY medication_id NOT NULL;
ALTER TABLE stock_alerts MODIFY alert_type NOT NULL;
ALTER TABLE stock_alerts MODIFY alert_date NOT NULL;
ALTER TABLE stock_alerts MODIFY message NOT NULL;
ALTER TABLE stock_alerts MODIFY resolved_flag NOT NULL;
-- Pharmacists
ALTER TABLE pharmacists MODIFY pharmacist_id NOT NULL;
ALTER TABLE pharmacists MODIFY name NOT NULL;
ALTER TABLE pharmacists MODIFY license_number NOT NULL;
ALTER TABLE pharmacists MODIFY email NOT NULL;
ALTER TABLE pharmacists MODIFY phone NOT NULL;
ALTER TABLE pharmacists MODIFY active_status NOT NULL;

SELECT 'âœ… Step 7 Complete: NOT NULL constraints added' as status FROM dual;

-- 8. ADD DEFAULT VALUES
ALTER TABLE batches MODIFY received_date DEFAULT SYSDATE;
ALTER TABLE prescriptions MODIFY issue_date DEFAULT SYSDATE;
ALTER TABLE prescriptions MODIFY created_date DEFAULT SYSDATE;
ALTER TABLE prescriptions MODIFY status DEFAULT 'PENDING';
ALTER TABLE prescription_lines MODIFY quantity_dispensed DEFAULT 0;
ALTER TABLE dispense_log MODIFY dispense_date DEFAULT SYSDATE;
ALTER TABLE dispense_log MODIFY override_flag DEFAULT 'N';
ALTER TABLE audit_log MODIFY changed_date DEFAULT SYSDATE;
ALTER TABLE stock_alerts MODIFY alert_date DEFAULT SYSDATE;
ALTER TABLE stock_alerts MODIFY resolved_flag DEFAULT 'N';
ALTER TABLE pharmacists MODIFY active_status DEFAULT 'Y';

SELECT 'âœ… Step 8 Complete: Default values added' as status FROM dual;

-- 9. VERIFY EVERYTHING
SELECT 'ðŸŽ‰ DATABASE SETUP COMPLETE!' as message FROM dual;
SELECT 'Total constraints created: ' || COUNT(*) as summary 
FROM user_constraints 
WHERE table_name IN (
    'MEDICATIONS', 'PATIENTS', 'BATCHES', 'PRESCRIPTIONS',
    'PRESCRIPTION_LINES', 'DRUG_INTERACTIONS', 'DISPENSE_LOG',
    'AUDIT_LOG', 'STOCK_ALERTS', 'PHARMACISTS'
);### **Query Type Demonstrations**

-- Procedure to add new patient
CREATE OR REPLACE PROCEDURE add_patient(
    p_name IN VARCHAR2,
    p_dob IN DATE,
    p_gender IN CHAR,
    p_phone IN VARCHAR2,
    p_address IN VARCHAR2,
    p_email IN VARCHAR2,
    p_patient_id OUT NUMBER
) AS
BEGIN
    SELECT seq_patients.NEXTVAL INTO p_patient_id FROM dual;
    
    INSERT INTO patients (patient_id, name, dob, gender, phone, address, email)
    VALUES (p_patient_id, p_name, p_dob, p_gender, p_phone, p_address, p_email);
    
    COMMIT;
END add_patient;
/

-- Procedure to dispense medication
CREATE OR REPLACE PROCEDURE dispense_medication(
    p_prescription_id IN NUMBER,
    p_line_id IN NUMBER,
    p_batch_id IN NUMBER,
    p_qty IN NUMBER,
    p_pharmacist_id IN NUMBER,
    p_override_flag IN CHAR DEFAULT 'N',
    p_override_reason IN VARCHAR2 DEFAULT NULL
) AS
    v_available_qty NUMBER;
    v_expiry_date DATE;
    v_patient_id NUMBER;
    v_medication_id NUMBER;
BEGIN
    -- Check stock availability
    SELECT qty_on_hand, expiry_date INTO v_available_qty, v_expiry_date
    FROM batches WHERE batch_id = p_batch_id;
    
    IF v_available_qty < p_qty THEN
        RAISE_APPLICATION_ERROR(-20001, 'Insufficient stock available');
    END IF;
    
    IF v_expiry_date < SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20002, 'Batch has expired');
    END IF;
    
    -- Log the dispense
    INSERT INTO dispense_log (dispense_id, prescription_id, line_id, batch_id, qty_dispensed, dispense_date, pharmacist_id, override_flag, override_reason)
    VALUES (seq_dispense_log.NEXTVAL, p_prescription_id, p_line_id, p_batch_id, p_qty, SYSDATE, p_pharmacist_id, p_override_flag, p_override_reason);
    
    -- Update batch quantity
    UPDATE batches 
    SET qty_on_hand = qty_on_hand - p_qty
    WHERE batch_id = p_batch_id;
    
    -- Update prescription line
    UPDATE prescription_lines
    SET quantity_dispensed = quantity_dispensed + p_qty
    WHERE line_id = p_line_id;
    
    COMMIT;
END dispense_medication;
/
