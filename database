-- SMART PHARMACY SYSTEM - DROP & RECREATE ALL TABLES
-- Run this entire script at once
-- ============================================

-- DISABLE FOREIGN KEY CONSTRAINTS TEMPORARILY
-- (This helps avoid "constraint exists" errors when dropping)

-- DROP TABLES IN REVERSE ORDER (due to foreign key dependencies)
BEGIN
    -- First, try to drop child tables
    EXECUTE IMMEDIATE 'DROP TABLE stock_alerts CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE audit_log CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE dispense_log CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE drug_interactions CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE prescription_lines CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE prescriptions CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE batches CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE patients CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE medications CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

DBMS_OUTPUT.PUT_LINE('All existing tables dropped (if they existed)');

-- ============================================
-- NOW CREATE ALL TABLES FRESH
-- ============================================

-- 1. MEDICATIONS (FOUNDATION TABLE)
CREATE TABLE medications (
    medication_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    generic_name VARCHAR2(100),
    requires_prescription CHAR(1) DEFAULT 'Y' CHECK (requires_prescription IN ('Y', 'N')),
    active_status VARCHAR2(10) DEFAULT 'ACTIVE' CHECK (active_status IN ('ACTIVE', 'DISCONTINUED')),
    CONSTRAINT uk_med_name UNIQUE (name)
);

DBMS_OUTPUT.PUT_LINE('Table MEDICATIONS created successfully');

-- 2. PATIENTS (SECOND FOUNDATION TABLE)
CREATE TABLE patients (
    patient_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    dob DATE NOT NULL,
    phone VARCHAR2(15),
    allergies VARCHAR2(500)
);

DBMS_OUTPUT.PUT_LINE('Table PATIENTS created successfully');

-- 3. BATCHES (NEEDS MEDICATIONS)
CREATE TABLE batches (
    batch_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    medication_id NUMBER NOT NULL,
    batch_number VARCHAR2(50) NOT NULL,
    expiry_date DATE NOT NULL,
    qty_received NUMBER NOT NULL CHECK (qty_received > 0),
    qty_on_hand NUMBER NOT NULL CHECK (qty_on_hand >= 0),
    purchase_price NUMBER(10,2) CHECK (purchase_price > 0),
    CONSTRAINT fk_batch_med FOREIGN KEY (medication_id) REFERENCES medications(medication_id),
    CONSTRAINT uk_batch_num UNIQUE (batch_number)
);

DBMS_OUTPUT.PUT_LINE('Table BATCHES created successfully');

-- 4. PRESCRIPTIONS (NEEDS PATIENTS)
CREATE TABLE prescriptions (
    prescription_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    patient_id NUMBER NOT NULL,
    prescriber_name VARCHAR2(100) NOT NULL,
    prescription_date DATE DEFAULT SYSDATE,
    status VARCHAR2(20) DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'DISPENSED', 'CANCELLED')),
    CONSTRAINT fk_pres_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
);

DBMS_OUTPUT.PUT_LINE('Table PRESCRIPTIONS created successfully');

-- 5. DRUG_INTERACTIONS (NEEDS MEDICATIONS)
CREATE TABLE drug_interactions (
    interaction_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    med1_id NUMBER NOT NULL,
    med2_id NUMBER NOT NULL,
    severity VARCHAR2(20) NOT NULL CHECK (severity IN ('LOW', 'MODERATE', 'HIGH')),
    description VARCHAR2(500),
    recommended_action VARCHAR2(500),
    CONSTRAINT fk_interaction_med1 FOREIGN KEY (med1_id) REFERENCES medications(medication_id),
    CONSTRAINT fk_interaction_med2 FOREIGN KEY (med2_id) REFERENCES medications(medication_id),
    CONSTRAINT chk_med_order CHECK (med1_id < med2_id)  -- Prevents duplicate (A,B) and (B,A)
);

DBMS_OUTPUT.PUT_LINE('Table DRUG_INTERACTIONS created successfully');

-- 6. PRESCRIPTION_LINES (NEEDS PRESCRIPTIONS & MEDICATIONS)
CREATE TABLE prescription_lines (
    line_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    prescription_id NUMBER NOT NULL,
    medication_id NUMBER NOT NULL,
    dosage VARCHAR2(50),
    quantity_prescribed NUMBER NOT NULL CHECK (quantity_prescribed > 0),
    quantity_dispensed NUMBER DEFAULT 0 CHECK (quantity_dispensed >= 0),
    CONSTRAINT fk_line_pres FOREIGN KEY (prescription_id) REFERENCES prescriptions(prescription_id),
    CONSTRAINT fk_line_med FOREIGN KEY (medication_id) REFERENCES medications(medication_id)
);

DBMS_OUTPUT.PUT_LINE('Table PRESCRIPTION_LINES created successfully');

-- 7. DISPENSE_LOG (NEEDS BATCHES & PRESCRIPTION_LINES)
CREATE TABLE dispense_log (
    dispense_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    prescription_id NUMBER,
    line_id NUMBER,
    batch_id NUMBER NOT NULL,
    qty_dispensed NUMBER NOT NULL CHECK (qty_dispensed > 0),
    dispensed_by VARCHAR2(100),
    dispensed_at TIMESTAMP DEFAULT SYSTIMESTAMP,
    override_flag CHAR(1) DEFAULT 'N' CHECK (override_flag IN ('Y', 'N')),
    override_reason VARCHAR2(500),
    CONSTRAINT fk_disp_pres FOREIGN KEY (prescription_id) REFERENCES prescriptions(prescription_id),
    CONSTRAINT fk_disp_line FOREIGN KEY (line_id) REFERENCES prescription_lines(line_id),
    CONSTRAINT fk_disp_batch FOREIGN KEY (batch_id) REFERENCES batches(batch_id)
);

DBMS_OUTPUT.PUT_LINE('Table DISPENSE_LOG created successfully');

-- 8. AUDIT_LOG (STANDALONE)
CREATE TABLE audit_log (
    log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    table_name VARCHAR2(50),
    operation VARCHAR2(10) CHECK (operation IN ('INSERT', 'UPDATE', 'DELETE')),
    record_id NUMBER,
    old_values CLOB,
    new_values CLOB,
    changed_by VARCHAR2(100),
    change_time TIMESTAMP DEFAULT SYSTIMESTAMP
);

DBMS_OUTPUT.PUT_LINE('Table AUDIT_LOG created successfully');

-- 9. STOCK_ALERTS (NEEDS MEDICATIONS)
CREATE TABLE stock_alerts (
    alert_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    medication_id NUMBER NOT NULL,
    alert_type VARCHAR2(20) CHECK (alert_type IN ('LOW_STOCK', 'NEAR_EXPIRY')),
    qty_on_hand NUMBER,
    alert_time TIMESTAMP DEFAULT SYSTIMESTAMP,
    resolved_flag CHAR(1) DEFAULT 'N' CHECK (resolved_flag IN ('Y', 'N')),
    CONSTRAINT fk_alert_med FOREIGN KEY (medication_id) REFERENCES medications(medication_id)
);

DBMS_OUTPUT.PUT_LINE('Table STOCK_ALERTS created successfully');

-- ============================================
-- CREATE INDEXES
-- ============================================

CREATE INDEX idx_medications_name ON medications(name);
CREATE INDEX idx_medications_status ON medications(active_status);

CREATE INDEX idx_batches_med_expiry ON batches(medication_id, expiry_date);
CREATE INDEX idx_batches_expiry ON batches(expiry_date);

CREATE INDEX idx_patients_name ON patients(name);

CREATE INDEX idx_prescriptions_patient ON prescriptions(patient_id);
CREATE INDEX idx_prescriptions_date ON prescriptions(prescription_date);

CREATE INDEX idx_pres_lines_pres ON prescription_lines(prescription_id);
CREATE INDEX idx_pres_lines_med ON prescription_lines(medication_id);

CREATE INDEX idx_dispense_batch ON dispense_log(batch_id);
CREATE INDEX idx_dispense_date ON dispense_log(dispensed_at);

CREATE INDEX idx_interactions_med1 ON drug_interactions(med1_id);
CREATE INDEX idx_interactions_med2 ON drug_interactions(med2_id);

DBMS_OUTPUT.PUT_LINE('All indexes created successfully');

-- ============================================
-- VERIFICATION
-- ============================================

-- Show all tables created
SELECT table_name, 'âœ“ CREATED' as status
FROM user_tables
WHERE table_name IN ('MEDICATIONS', 'PATIENTS', 'BATCHES', 'PRESCRIPTIONS', 
                     'PRESCRIPTION_LINES', 'DRUG_INTERACTIONS', 'DISPENSE_LOG', 
                     'AUDIT_LOG', 'STOCK_ALERTS')
ORDER BY table_name;

-- Count tables
SELECT 'TOTAL TABLES CREATED: ' || COUNT(*) as summary
FROM user_tables
WHERE table_name IN ('MEDICATIONS', 'PATIENTS', 'BATCHES', 'PRESCRIPTIONS', 
                     'PRESCRIPTION_LINES', 'DRUG_INTERACTIONS', 'DISPENSE_LOG', 
                     'AUDIT_LOG', 'STOCK_ALERTS');
